generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String
  firstName   String
  lastName    String
  isActive    Boolean   @default(true)
  storeId     String?
  phone       String?
  address     String?
  dateOfBirth DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  carts       Cart[]    @relation("CustomerCarts")
  orders      Order[]   @relation("CustomerOrders")
  salesMade   Sale[]    @relation("SalesCashier")
  ownedStore  Store?    @relation("StoreOwner")

  @@map("users")
}

model Store {
  id             String         @id @default(cuid())
  name           String
  description    String?
  address        String
  phone          String
  email          String
  slug           String         @unique
  isActive       Boolean        @default(true)
  isPublic       Boolean        @default(false)
  ownerId        String         @unique
  cacNumber      String?
  tin            String?
  vatRegistered  Boolean        @default(false)
  currency       String         @default("NGN")
  state          String?
  country        String         @default("Nigeria")
  logoUrl        String?
  primaryColor   String         @default("#000000")
  secondaryColor String         @default("#ffffff")
  accentColor    String         @default("#3b82f6")
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deployedAt     DateTime?
  auditLogs      AuditLog[]
  orders         Order[]
  products       Product[]
  purchases      Purchase[]
  sales          Sale[]
  storeProducts  StoreProduct[]
  settings       StoreSettings?
  owner          User           @relation("StoreOwner", fields: [ownerId], references: [id])
  taxPeriods     TaxPeriod[]
  taxRecords     TaxRecord[]
  taxSummaries   TaxSummary[]
  tools          Tool[]         @relation("StoreTools")

  @@map("stores")
}

model Product {
  id                String         @id @default(cuid())
  name              String
  description       String?
  category          String
  costPrice         Float
  sellingPrice      Float
  stockQuantity     Int
  lowStockThreshold Int            @default(10)
  barcode           String?
  imageUrl          String?
  isActive          Boolean        @default(true)
  storeId           String
  taxCategory       String         @default("VATABLE")
  vatRate           Float          @default(7.5)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  cartItems         CartItem[]
  orderItems        OrderItem[]
  store             Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  saleItems         SaleItem[]
  storeProducts     StoreProduct[]

  @@map("products")
}

model Sale {
  id            String     @id @default(cuid())
  storeId       String
  cashierId     String
  customerId    String?
  customerName  String?
  customerPhone String?
  customerAddress String?
  deliveryType  String     @default("WALK_IN") // WALK_IN, DELIVERY, PICKUP
  deliveryPrice Float      @default(0)
  deliveryAddress String?
  deliveryStatus String?    // PENDING, ASSIGNED, SHIPPED, OUT_FOR_DELIVERY, DELIVERED, FAILED
  riderName     String?
  riderPhone    String?
  parcelNumber  String?
  deliveryNotes String?
  deliveredAt   DateTime?
  deliveryDuration Int?     // Duration in hours
  invoiceNumber String     @unique
  subtotal      Float
  tax           Float
  discount      Float      @default(0)
  total         Float
  grossAmount   Float
  vatAmount     Float
  netAmount     Float
  paymentMethod String     @default("POS")
  taxPeriodId   String?
  notes         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  items         SaleItem[]
  cashier       User       @relation("SalesCashier", fields: [cashierId], references: [id])
  store         Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  taxPeriod     TaxPeriod? @relation(fields: [taxPeriodId], references: [id])
  taxRecord     TaxRecord? @relation("SaleTaxRecord")

  @@map("sales")
}

model SaleItem {
  id          String  @id @default(cuid())
  saleId      String
  productId   String
  productName String
  quantity    Int
  unitPrice   Float
  subtotal    Float
  taxCategory String
  vatRate     Float
  vatAmount   Float
  totalAmount Float
  product     Product @relation(fields: [productId], references: [id])
  sale        Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("sale_items")
}

model Cart {
  id         String     @id @default(cuid())
  userId     String     @unique
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  items      CartItem[]
  user       User       @relation("CustomerCarts", fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  quantity  Int
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Order {
  id                String      @id @default(cuid())
  orderNumber       String      @unique
  storeId           String
  customerId        String?
  customerFirstName String
  customerLastName  String
  customerEmail     String
  customerPhone     String
  customerAddress   String?
  deliveryType      String      @default("WALK_IN") // WALK_IN, DELIVERY, PICKUP
  deliveryPrice     Float       @default(0)
  deliveryAddress   String?
  deliveryStatus    String?     // PENDING, ASSIGNED, SHIPPED, OUT_FOR_DELIVERY, DELIVERED, FAILED
  riderName         String?
  riderPhone        String?
  parcelNumber      String?
  deliveryNotes     String?
  deliveredAt       DateTime?
  deliveryDuration  Int?        // Duration in hours
  subtotal          Float
  tax               Float
  shipping          Float       @default(0)
  discount          Float       @default(0)
  total             Float
  status            String      @default("PENDING")
  paymentStatus     String      @default("PENDING")
  paymentMethod     String?
  notes             String?
  vatRate           Float       @default(0)
  vatAmount         Float       @default(0)
  taxableAmount     Float       @default(0)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  items             OrderItem[]
  customer          User?       @relation("CustomerOrders", fields: [customerId], references: [id])
  store             Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  taxRecord         TaxRecord?  @relation("OrderTaxRecord")

  @@map("orders")
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String
  productName String
  unitPrice   Float
  quantity    Int
  subtotal    Float
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Tool {
  id                String   @id @default(cuid())
  name              String
  type              String
  serialNumber      String
  itemNumber        String
  status            String   @default("ACTIVE")
  unitOfMeasurement String
  amount            Float
  price             Float
  datePurchased     DateTime
  currency          String
  store             String
  project           String
  department        String
  category          String
  manufacturer      String
  description       String
  imageUrl          String?
  warrantyUrl       String?
  piDocumentUrl     String?
  storeId           String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  storeRelation     Store    @relation("StoreTools", fields: [storeId], references: [id], onDelete: Cascade)

  @@map("tools")
}

model StoreSettings {
  id                String   @id @default(cuid())
  storeId           String   @unique
  vatEnabled        Boolean  @default(true)
  vatRate           Float    @default(0.075)
  taxIdNumber       String?
  businessRegNumber String?
  businessType      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("store_settings")
}

model TaxRecord {
  id              String   @id @default(cuid())
  storeId         String
  saleId          String?  @unique
  orderId         String?  @unique
  taxableAmount   Float
  vatRate         Float
  vatCollected    Float
  totalAmount     Float
  transactionType String
  paymentMethod   String
  taxPeriod       String
  taxYear         Int
  taxMonth        Int
  createdAt       DateTime @default(now())
  order           Order?   @relation("OrderTaxRecord", fields: [orderId], references: [id])
  sale            Sale?    @relation("SaleTaxRecord", fields: [saleId], references: [id])
  store           Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("tax_records")
}

model TaxSummary {
  id                String   @id @default(cuid())
  storeId           String
  period            String
  totalSales        Float
  totalVatCollected Float
  totalOrders       Int
  totalRevenue      Float
  year              Int
  month             Int
  generatedAt       DateTime @default(now())
  isFinalized       Boolean  @default(false)
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, period])
  @@map("tax_summaries")
}

model StoreProduct {
  id         String   @id @default(cuid())
  storeId    String
  productId  String
  isDeployed Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, productId])
  @@map("store_products")
}

model TaxPeriod {
  id           String     @id @default(cuid())
  storeId      String
  startDate    DateTime
  endDate      DateTime
  status       String     @default("OPEN")
  closedAt     DateTime?
  closedBy     String?
  totalSales   Float?
  vatableSales Float?
  outputVat    Float?
  inputVat     Float?
  vatPayable   Float?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  purchases    Purchase[]
  sales        Sale[]
  store        Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("tax_periods")
}

model Purchase {
  id            String     @id @default(cuid())
  storeId       String
  supplierName  String
  supplierTin   String?
  invoiceNumber String
  date          DateTime
  grossAmount   Float
  vatAmount     Float
  netAmount     Float
  description   String?
  paymentMethod String     @default("Transfer")
  taxPeriodId   String?
  recordedBy    String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  store         Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  taxPeriod     TaxPeriod? @relation(fields: [taxPeriodId], references: [id])

  @@map("purchases")
}

model AuditLog {
  id          String   @id @default(cuid())
  storeId     String
  entityType  String
  entityId    String
  action      String
  oldValue    String?
  newValue    String?
  performedBy String
  timestamp   DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}
